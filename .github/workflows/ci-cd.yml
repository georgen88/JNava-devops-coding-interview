###############################################################################
# CI/CD Pipeline — Flights API
#
# Push to main  → test → validate → plan → build → apply → deploy
# PR to main    → test → validate → plan → PR comment (no deploy)
#
# Rollback: git revert on main re-triggers the pipeline automatically.
###############################################################################

name: "CI/CD Pipeline"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  APP_NAME: flights-api
  ENVIRONMENT: prod

jobs:

  # ── 1. Application Tests (pytest) ──────────────────────────────────────────
  app-tests:
    name: "Run Tests (pytest)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run pytest
        working-directory: api
        run: python -m pytest tests/ -v --tb=short
        env:
          MONGO_URI: "mongodb://localhost:27017"
          MONGO_DB_NAME: "flights"

  # ── 2. Terraform Validate ──────────────────────────────────────────────────
  terraform-validate:
    name: "Terraform Validate"
    runs-on: ubuntu-latest
    needs: app-tests
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ env.APP_NAME }}/${{ env.ENVIRONMENT }}/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Format Check
        run: terraform fmt -check -diff

      - name: Terraform Validate
        run: terraform validate -no-color

  # ── 3. Terraform Plan ──────────────────────────────────────────────────────
  terraform-plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    needs: terraform-validate
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ env.APP_NAME }}/${{ env.ENVIRONMENT }}/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var="db_username=${{ secrets.DB_USERNAME }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="docdb_username=${{ secrets.DOCDB_USERNAME }}" \
            -var="docdb_password=${{ secrets.DOCDB_PASSWORD }}" \
            -var="app_image=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.APP_NAME }}:${{ github.sha }}" \
            -no-color \
            -out=tfplan 2>&1 | tee plan_output.txt

      - uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan_output.txt', 'utf8');
            const truncated = plan.length > 60000
              ? plan.substring(0, 60000) + '\n... truncated'
              : plan;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### Terraform Plan\n\`\`\`\n${truncated}\n\`\`\``
            });

  # ── 4. Docker Build & Push (main only) ─────────────────────────────────────
  docker-build:
    name: "Docker Build & Push"
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, Tag & Push
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            -t $ECR_REGISTRY/${{ env.APP_NAME }}:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ env.APP_NAME }}:latest \
            -f docker/Dockerfile .
          docker push $ECR_REGISTRY/${{ env.APP_NAME }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ env.APP_NAME }}:latest

      - name: Save Image Metadata Artifact
        run: |
          echo '{"image":"${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.APP_NAME }}:${{ github.sha }}","sha":"${{ github.sha }}"}' > image-metadata.json
      - uses: actions/upload-artifact@v4
        with:
          name: image-metadata
          path: image-metadata.json

  # ── 5. Terraform Apply (main only) ─────────────────────────────────────────
  terraform-apply:
    name: "Terraform Apply"
    runs-on: ubuntu-latest
    needs: [terraform-plan, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ env.APP_NAME }}/${{ env.ENVIRONMENT }}/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve \
            -var="db_username=${{ secrets.DB_USERNAME }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="docdb_username=${{ secrets.DOCDB_USERNAME }}" \
            -var="docdb_password=${{ secrets.DOCDB_PASSWORD }}" \
            -var="app_image=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.APP_NAME }}:${{ github.sha }}"

  # ── 6. Deploy to ECS (main only) ───────────────────────────────────────────
  deploy:
    name: "Deploy to ECS"
    runs-on: ubuntu-latest
    needs: terraform-apply
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Force New ECS Deployment
        run: |
          aws ecs update-service \
            --cluster ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-cluster \
            --service ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-service \
            --force-new-deployment

      - name: Wait for Stability
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-cluster \
            --services ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-service
